<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <title>Rufus and the Magic Mushrooms</title>
        <script type="text/javascript" src="../../../dist/sizzle.js"></script>
        <script type="text/javascript" src="../../../dist/joy.js"></script>
        <style type="text/css">
          body { margin: 0; padding: 0; zoom: 100%; }
        </style>
    </head>
    <body>
      <script type="text/javascript">
          var tileset = new Joy.Tileset({
            src: "assets/tilesets/bright.png",
            width: 64,
            height: 64
          });

          var maps = [
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 13, 17, 14, 17, 14, 14, 17, 14, 14, 14, 17, 17, 17, 17, 14, 14, 14, 14, 14, 14, 14, 17, 17, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 25, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 31, 5, 2, 2, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 13, 14, 14, 17, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 20, 8, 9, 11, 11, 10, 19, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 4, 5, 4, 4, 4, 20, 10, 10, 10, 8, 11, 9, 9, 19, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 5, 2, 5, 4, 5, 5, 2, 2, 20, 8, 10, 11, 8, 10, 10, 11, 10, 8, 8, 9, 8, 8, 8, 19, 2, 2, 3, 3, 3, 2, 2, 3, 3, 5, 4, 4, 3, 3, 3, 3, 2, 5, 4, 4, 4, 3, 5, 2, 2, 5, 5, 2, 0, 0, 0, 0, 0, 1, 20, 9, 10, 10, 9, 10, 8, 9, 10, 11, 8, 8, 9, 11, 10, 8, 8, 8, 8, 10, 11, 11, 8, 9, 8, 10, 10, 10, 10, 10, 10, 10, 10, 10, 8, 11, 8, 11, 11, 11, 10, 10, 10, 8, 8, 8, 10, 8, 8, 11, 11, 8, 11, 10, 3, 5, 3, 5, 2, 20, 8, 9, 11, 8, 8, 8, 11, 10, 11, 10, 10, 8, 11, 10, 9, 11, 10, 8, 10, 11, 8, 8, 8, 8, 8, 11, 9, 8, 11, 11, 8, 10, 8, 8, 9, 11, 8, 8, 8, 10, 10, 11, 10, 11, 8, 8, 11, 11, 11, 11, 11, 11, 11, 10],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 25, 0, 0, 0, 0, 0, 5, 2, 4, 4, 4, 5, 5, 2, 3, 31, 4, 5, 2, 3, 4, 27, 10, 10, 8, 8, 9, 8, 11, 10, 11, 10, 11, 11, 27, 11],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 17, 17, 17, 17, 18, 0, 0, 0, 0, 0, 1, 4, 3, 2, 12, 0, 0, 0, 0, 0, 0, 25, 0, 0, 1, 20, 9, 10, 11, 19, 3, 2, 5, 3, 5, 5, 31, 5, 2, 20, 8, 10, 8, 27],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 13, 14, 14, 14, 14, 0, 0, 0, 0, 0, 0, 0, 25, 0, 0, 0, 0, 0, 0, 0, 5, 4, 4, 3, 5, 4, 4, 31, 5, 2, 5, 5, 4, 2, 3, 27, 8, 11, 8, 10, 9, 10, 10, 11, 11, 11, 10, 10, 11, 11],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 19, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 20, 11, 27, 19, 2, 5, 5, 5, 5, 2, 4, 3, 4, 2, 20, 9, 10],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 6, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 7, 12, 0, 0, 0, 13, 14, 14, 15, 0, 0, 0, 0, 0, 0, 7, 19, 2, 6, 0, 0, 0, 0, 7, 0, 0, 0, 0, 0, 0, 29, 21, 9, 16, 17, 18, 0, 0, 7, 0, 0, 0, 0, 0, 0, 0, 29, 21, 12, 0, 0, 0, 1, 20, 0, 0, 1, 6, 0, 0, 0, 0, 29, 30, 0, 0, 1, 20, 8, 0, 1, 20, 19, 6, 0, 0, 0, 0, 0, 0, 1, 20, 11, 27, 5, 20, 9, 11, 19, 3, 3, 5, 4, 5, 4, 20, 8, 11, 10],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 25, 0, 0, 0, 0, 0, 0, 1, 4, 2, 5, 5, 4, 0, 1, 31, 6, 0, 0, 0, 0, 0, 7, 11, 9, 8, 11, 27, 5, 20, 9, 19, 5, 4, 3, 5, 3, 20, 8, 8, 11, 9, 10],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 19, 6, 0, 0, 0, 0, 0, 36, 17, 18, 0, 13, 14, 14, 15, 9, 12, 0, 0, 0, 0, 0, 12, 0, 0, 0, 0, 0, 0, 29, 23, 30, 0, 0, 0, 0, 0, 19, 3, 6, 0, 1, 6, 0, 0, 0, 0, 0, 25, 0, 0, 0, 11, 10, 12, 0, 7, 19, 4, 4, 5, 3, 2, 31, 4, 4, 2, 9, 10, 19, 2, 20, 8, 11, 10, 9, 11, 8, 10, 10, 27, 11],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 25, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 32, 0, 0, 0, 13, 35, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 13, 18, 0, 0, 7, 0, 0, 0, 0, 1, 2, 6, 0, 0, 0, 0, 0, 0, 1, 20, 6, 0, 1, 3, 20, 11, 19, 2, 5, 3, 3, 4, 3, 20, 10, 19, 3, 20, 10, 9, 11, 10, 27, 11, 8, 10, 9, 8, 10, 8],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 6, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 6, 0, 1, 20, 12, 0, 0, 0, 0, 0, 0, 0, 0, 7, 22, 30, 0, 29, 23, 30, 0, 0, 0, 0, 1, 6, 0, 0, 7, 12, 0, 0, 0, 0, 0, 0, 1, 6, 0, 7, 12, 0, 1, 20, 12, 0, 0, 0, 0, 0, 0, 7, 12, 0, 29, 30, 0, 29, 23, 19, 4, 5, 5, 5, 3, 2, 20, 12, 0, 0, 0, 0, 0, 0, 11, 8, 27, 11, 9, 8, 8, 10, 19, 3, 5, 2, 2, 4, 5],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 13, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 13, 17, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 13, 14, 18, 0, 0, 0, 0, 0, 0, 0, 0, 25, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 3, 31, 6, 0, 0, 0, 0, 0, 1, 3, 3, 3, 3, 2, 3, 0, 0, 0, 13, 15, 9, 8, 12, 0, 0, 0, 0, 1, 20, 8, 8, 8, 8, 8, 11, 5, 6, 0, 0, 7, 11, 8, 19, 6, 0, 0, 1, 20, 27, 11, 8, 9, 11, 11, 10, 11, 19, 3, 4, 20, 10, 8, 27, 19, 3, 3, 20, 11, 9, 10, 10, 10, 8, 10, 9],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 13, 14, 15, 12, 0, 0, 0, 0, 0, 0, 13, 14, 18, 0, 0, 0, 0, 7, 12, 0, 6, 0, 0, 0, 0, 0, 0, 0, 0, 13, 14, 14, 15, 19, 2, 19, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 27, 11, 27, 19, 2, 3, 6, 0, 0, 1, 3, 3, 3, 2, 20, 11, 10, 10, 8, 8, 10, 12, 0, 0, 7, 8, 8, 11, 8, 9, 8, 10, 8, 11, 11, 9, 19, 2, 5, 20, 11, 8, 8, 11, 8, 8, 27]
          ];

          var tilemap = new Joy.Tilemap({
            tileset: tileset,
            columns: 60,
            lines: 10,
            data: maps[0]
          });

          var engine = new Joy.Engine({debug: true, width: 960, height: 640});

          var scene = engine.createScene();
          scene.background("#BFE5E5");

          var RufusBehaviour = Joy.Behaviour.extend({
            INIT: function() {
              this.behave(Joy.Behaviour.Movimentation);
              this.maxVelocity = new Joy.Vector2d(2, 2);
              this.friction.x = 0.1;
              this.vspeedMax = 10;
              this.vspeed = 0;
              this.grounded = false;
            },

            UPDATE: function() {
              if (!this.grounded) {
                this.vspeed += 0.5;
              }

              // Play idle animation
              if (this.grounded && Math.abs(this.velocity.x) < 1) {
                this.play("idle");
              }

              this.position.y += this.vspeed;
            },

            KEY_UP: function(evt) {
              this.acceleration.x = 0;
            },

            KEY_DOWN: function(evt) {
              if (evt.keyCode == Joy.Keyboard.SPACE && this.grounded) {
                this.play("jumping");
                this.grounded = false;
                this.vspeed = -10;
              }
            },

            COLLISION_ENTER: function(other) {
              if (other instanceof Joy.Tilemap) {
                console.log("Collision enter");
                this.grounded = true;
                this.vspeed = 0;
              }
            },

            COLLISION_EXIT: function (other) {
              this.grounded = false;
              console.log("Collision exit: ", other);
            },

            KEY_PRESS: function(evt) {
              if (evt.keyCode == Joy.Keyboard.LEFT) {
                if (!this.willCollideAt(new Joy.Vector2d(-3, -3))) {
                  this.acceleration.x = -2;
                  this.flipX = false;
                  if (this.grounded) {
                    this.play("walking");
                  }
                }
              } else if (evt.keyCode == Joy.Keyboard.RIGHT) {
                if (!this.willCollideAt(new Joy.Vector2d(this.collider.width + 3, -3))) {
                  this.acceleration.x = 2;
                  this.flipX = true;
                  if (this.grounded) {
                    this.play("walking");
                  }
                } else {
                  this.acceleration.x = 0;
                }
              }
            }
          });

          var rufus = new Joy.SpriteSheet({
            id: "rufus",
            x: engine.width / 2,
            y: engine.height / 2,
            src: "assets/spritesheets/rufus.png",
            width: 120,
            height: 120,
            animations: {
              "walking": [0, 30],
              "idle": [31, 39],
              "jumping": [40, 59],
              "falling": [60, 67],
            }
          }).behave(RufusBehaviour);

          var parallax = new Joy.Parallax({
            pivot: rufus,
            distance: 1,
            children: [
              new Joy.Sprite("assets/background/parallax-3.png"),
              new Joy.Sprite("assets/background/parallax-2.png"),
              new Joy.Sprite("assets/background/parallax-1.png"),
              tilemap,
            ]
          });

          rufus.collider = new Joy.RectCollider(new Joy.Vector2d(30, 40), 60, 45);
          rufus.allowCollisionFrom(parallax.getChildAt(3));
          rufus.play("walking");

          scene.createViewport({
            follow: rufus,
            width: 480,
            height: 320
          });

          scene.addChild(parallax);
          scene.addChild(rufus);
      </script>
    </body>
</html>


