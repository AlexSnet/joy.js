/* 
 * joy.js v0.0.1pre 
 * http://joyjs.org
 * 
 * @copyright 2012-2013 Endel Dreyer 
 * @license MIT
 * @build 1/24/2013
 */
(function(t){var i=t.Joy||{Init:{},Render:{},Input:{},Context:{},Events:{INIT:"init",ADDED:"added",REMOVED:"removed",UPDATE:"update",COLLISION:"collision",COLLISION_ENTER:"collisionEnter",COLLISION_EXIT:"collisionExit"},debug:!1,deltaTime:1,ready:function(t){document.onload=t}};i.generateUniqueId=function(){return"joy"+(new Date).getTime()},t.Joy=i})(window),function(){var t=!1,i=/xyz/.test(function(){"xyz"})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(e){function n(){!t&&this.init&&this.init.apply(this,arguments)}var s=this.prototype;t=!0;var o=new this;t=!1;for(var h in e)o[h]="function"==typeof e[h]&&"function"==typeof s[h]&&i.test(e[h])?function(t,i){return function(){var e=this._super;this._super=s[t];var n=i.apply(this,arguments);return this._super=e,n}}(h,e[h]):e[h];return n.prototype=o,n.prototype.constructor=n,n.extend=arguments.callee,n},Joy.Object=Class}(Joy),function(t){var i=function(t,i,e,n,s,o){return null!==t&&(this.m11=t),this.m12=i||0,this.m21=e||0,null!==n&&(this.m22=n),this.dx=s||0,this.dy=o||0,this};i.prototype.appendTransform=function(t,e,n,s,o,h,r,a,c){var l,d,u;return o%360?(u=o*i.DEG_TO_RAD,l=Math.cos(u),d=Math.sin(u)):(l=1,d=0),h||r?(h*=i.DEG_TO_RAD,r*=i.DEG_TO_RAD,this.append(Math.cos(r),Math.sin(r),-Math.sin(h),Math.cos(h),t,e),this.append(l*n,d*n,-d*s,l*s,0,0)):this.append(l*n,d*n,-d*s,l*s,t,e),(a||c)&&(this.dx-=a*this.m11+c*this.m21,this.dy-=a*this.m12+c*this.m22),this},i.prototype.append=function(t,i,e,n,s,o){var h=this.m11,r=this.m12,a=this.m21,c=this.m22;return this.m11=t*h+i*a,this.m12=t*r+i*c,this.m21=e*h+n*a,this.m22=e*r+n*c,this.dx=s*h+o*a+this.dx,this.dy=s*r+o*c+this.dy,this},i.prototype.invert=function(){var t=this.m11,i=this.m12,e=this.m21,n=this.m22,s=this.dx,o=t*n-i*e;return this.m11=n/o,this.m12=-i/o,this.m21=-e/o,this.m22=t/o,this.dx=(e*this.dy-n*s)/o,this.dy=-(t*this.dy-i*s)/o,this},i.prototype.clone=function(){return new i(this.m11,this.m12,this.m21,this.m22,this.dx,this.dy)},i.prototype.identity=function(){return this.m11=this.m22=1,this.m12=this.m21=this.dx=this.dy=0,this},i.DEG_TO_RAD=Math.PI/180,i.identity=new i(1,0,0,1,0,0),t.Matrix2D=i}(Joy),function(t){var i=t.Object.extend({init:function(){this._handlers={}},behave:function(t){var i=new t;for(var e in i)"string"==typeof Joy.Events[e]?this.bind(Joy.Events[e],i[e]):"constructor"!==e&&(this[e]=i[e]);return this},bind:function(t,e){var n=e;return void 0!==i._custom.bind[t]&&(n={target:this,handler:e},i._custom.bind[t].call(this,n)),void 0===this._handlers[t]&&(this._handlers[t]=[]),-1===this._handlers[t].indexOf(n)&&this._handlers[t].push(n),this},unbind:function(t){if(void 0!==i._custom.unbind[t])for(var e=0,n=this._handlers[t].length;n>e;++e)i._custom.unbind[t].call(this,this._handlers[t][e]);return this._handlers[t]=null,this},trigger:function(t,i,e){var n=this._handlers[t]||[];i=i||[],e=e||0;for(var s=0,o=n.length;o>s;++s)n[s].apply(this,i)}});i._custom={bind:{},unbind:{}},i.register=function(t,e,n){return i._custom.bind[t]=e,i._custom.unbind[t]=n,this},i.register(Joy.Events.INIT,function(t){t.handler.call(this)}),t.Triggerable=i}(Joy),function(t){var i=function(t){this.setCanvas(t.canvas)};i.prototype.setCanvas=function(t){return this.canvas=t,this.ctx=t.getContext("2d"),this},i.prototype.clear=function(){return this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this},i.prototype.render=function(t){this.clear();for(var i=0,e=t.length;e>i;++i)t[i].render()},t.Context.Context2d=i}(Joy),function(t){var i=t.Triggerable.extend({init:function(i){i||(i={}),this.id=i.id||Joy.generateUniqueId(),this.position=i.position||new t.Vector2d(i.x||0,i.y||0),this.__defineGetter__("collidePosition",function(){var i=null!==this._parent?this._parent.collidePosition:new t.Vector2d;return i.sum(this.position).subtract(this.pivot)}),this.pivot=new t.Vector2d(i.pivotX||0,i.pivotY||0),this.skew=new t.Vector2d(i.skewX||0,i.skewY||0),this.scale=new t.Vector2d(i.scaleX||1,i.scaleY||1),this.alpha=i.alpha||1,this.rotation=i.rotation||0,this.smooth=i.smooth||!1,this._width=i.width||0,this._height=i.height||0,this.collider=i.collider||this,this.index=null,this.ctx=i.ctx||null,this._shadow=null,this._parent=null,this._visible=i.visible||!0,this._matrix=t.Matrix2D.identity.clone(),this._collisionTargets=[],this._collisionActive={},this._hasContextOperations=!1,this._contextOperations={},this.__defineGetter__("parent",function(){return this._parent}),this.__defineGetter__("visible",function(){return this._visible&&this.alpha>0&&0!==this.scale.y&&0!==this.scale.y}),this.__defineSetter__("visible",function(t){this._visible=t}),this.__defineGetter__("matrix",function(){return this._matrix}),this.__defineGetter__("width",function(){return this._width*Math.abs(this.scale.x)}),this.__defineGetter__("height",function(){return this._height*Math.abs(this.scale.y)}),this.__defineGetter__("right",function(){return this.position.x+this.width}),this.__defineGetter__("bottom",function(){return this.position.y+this.height}),this.flipX=!1,this.flipY=!1,this._super(),this.collider&&this.bind(t.Events.UPDATE,this.checkCollisions)},setContext:function(t){this.ctx=t},setScale:function(t,i){this.scale.x=t,this.scale.y=i},allowCollisionFrom:function(t){return this._collisionTargets.push(t),this},translate:function(t,i){return this._hasContextOperations=!0,this._contextOperations.translate=[t,i],this},rotate:function(t){this.rotation=t},transform:function(t,i,e,n,s,o){return this._contextOperations.transform=[t,i,e,n,s,o],this},composite:function(t){return this.compositeOperation=t,this},fillStyle:function(t){return this._hasContextOperations=!0,this._contextOperations.fillStyle=""+t,this},fillRect:function(t,i,e,n){return this._hasContextOperations=!0,this._contextOperations.fillRect=[t,i,e,n],this},shadow:function(t){return this._shadow=t?{color:t.color||"#000",offsetX:t.offsetX||0,offsetY:t.offsetY||0,blur:t.blur||1}:null,this},updateContext:function(){var i={};i[!1]=-1,i[!0]=1;var e=this._matrix.identity().appendTransform(this.position.x+this.width*(this.flipX+0),this.position.y+this.height*(this.flipY+0),this.scale.x*i[!this.flipX],this.scale.y*i[!this.flipY],this.rotation,this.skew.x,this.skew.y,this.pivot.x,this.pivot.y);this.ctx.transform(e.m11,e.m12,e.m21,e.m22,e.dx,e.dy),this.ctx.globalAlpha*=this.alpha,this.compositeOperation&&(this.ctx.globalCompositeOperation=this.compositeOperation),this.ctx[t.Support.imageSmoothingEnabled]=this.smooth,this._shadow&&(this.ctx.shadowColor=this._shadow.color,this.ctx.shadowOffsetX=this._shadow.offsetX,this.ctx.shadowOffsetY=this._shadow.offsetY,this.ctx.shadowBlur=this._shadow.blur)},collide:function(t){return!(this.collidePosition.x>=t.collidePosition.x+t.width||t.collidePosition.x>=this.collidePosition.x+this.width||this.collidePosition.y>=t.collidePosition.y+t.height||t.collidePosition.y>=this.collidePosition.y+this.height)},checkCollisions:function(){var i,e=this._collisionTargets.length;void 0!==this.collider.updateColliderPosition&&this.collider.updateColliderPosition(this.position),t.debug&&this.collider.renderStroke(this.ctx);for(var n=0;e>n;++n)i=this._collisionTargets[n].collider,i.collide(this.collider)?(this._collisionActive[i]||(this.trigger(t.Events.COLLISION_ENTER,[this._collisionTargets[n]]),this._collisionActive[i]=!0),this.trigger(t.Events.COLLISION,[this._collisionTargets[n]])):this._collisionActive[i]&&(delete this._collisionActive[i],this.trigger(t.Events.COLLISION_EXIT,[this._collisionTargets[n]]))},willCollideAt:function(i){var e=new t.RectCollider(this.collider.position.clone().sum(i),1,1),n=this._collisionTargets.length;if(0!==n){e.updateColliderPosition(this.position);for(var s=0;n>s;++s)if(this._collisionTargets[s].collider.collide(e))return this._collisionTargets[s];return null}},render:function(){if(this._hasContextOperations)for(var t in this._contextOperations)this._contextOperations[t]instanceof Array?this.ctx[t].apply(this.ctx,this._contextOperations[t]):this.ctx[t]=this._contextOperations[t]},renderStroke:function(t){t.strokeStyle="red",t.strokeRect(0,0,this._width,this._height)},getMatrix:function(){return this._matrix.clone()},getBounds:function(){return new t.Rect(this.position.x,this.position.y,this.width,this.height)}});t.DisplayObject=i}(Joy),function(t){var i=t.DisplayObject.extend({init:function(t){if(t||(t={}),this.children=[],this.__defineGetter__("numChildren",function(){return this.children.length}),this.__defineGetter__("width",function(){for(var t=0,i=0,e=this.children.length;e>i;++i)this.children[i].width>t&&(t=this.children[i].width);return t}),this.__defineGetter__("height",function(){for(var t=0,i=0,e=this.children.length;e>i;++i)this.children[i].height>t&&(t=this.children[i].height);return t}),this._super(t),t.children)for(var i=0,e=t.children.length;e>i;++i)this.addChild(t.children[i])},setContext:function(t){this.ctx=t;for(var i=0,e=this.children.length;e>i;++i)this.children[i].setContext(t)},render:function(){this.visible&&(this.ctx.save(),this.updateContext(),this._super(),this.renderChildren(),this.ctx.restore())},renderChildren:function(){for(var t=0,i=this.children.length;i>t;++t)this.children[t].visible&&(this.ctx.save(),this.children[t].updateContext(),this.children[t].render(),this.children[t].trigger("update"),this.ctx.restore())},swapChildren:function(t,i){if(t.parent!==i.parent)throw Error("DisplayObject must be at same level to swap.");var e=t.index;return this.children[e]=i,this.children[i.index]=t,t.index=i.index,i.index=e,this},addChild:function(i){return i.setContext(this.ctx),i.index=this.children.push(i)-1,i._parent=this,i.trigger(t.Events.ADDED,[this]),this},getChildAt:function(t){return this.children[t]},removeChild:function(t){return this.removeChildAt(t.index)},removeChildAt:function(i){var e=this.children.splice(i,i+1)[0];return e.trigger(t.Events.REMOVED,[this]),this}});t.DisplayObjectContainer=i}(Joy),function(t){var i=t.DisplayObject.extend({init:function(t){t||(t={}),this.__defineSetter__("geom",function(t){this._geom=t}),this.__defineGetter__("geom",function(){return this._geom}),t.geom&&(this.geom=t.geom),this._super(t),this.__defineGetter__("width",function(){return this._geom.width}),this.__defineGetter__("height",function(){return this._geom.height})},render:function(){this._super(),this._geom.render(this.ctx)}});t.Shape=i}(Joy),function(t){var i=t.DisplayObjectContainer.extend({init:function(t){"string"==typeof t&&(t={src:t}),this.image=t.image||new Image,t.width=this.image.width||t.width,t.height=this.image.height||t.height,this._super(t),this.bind("load",this.onLoad),t.src&&this.load(t.src)},load:function(t){var i=this;this.image.onload=function(){i.trigger("load")},this.image.src=t},onLoad:function(){this._width||(this._width=this.image.width),this._height||(this._height=this.image.height)},render:function(){this.visible&&(this.ctx.drawImage(this.image,0,0,this._width,this._height),this.renderChildren())}});t.Sprite=i}(Joy),function(t){var i=t.Sprite.extend({init:function(t){var i=this;if(this._super(t),this._animations={length:0},this._frequencyInterval=null,this.frames=1,this.currentFrame=0,this.framesPerSecond=t.framesPerSecond||t.fps||24,t.animations)for(var e in t.animations)t.animations[e]instanceof Array&&this.addAnimation(e,t.animations[e]);this._currentAnimation=null,this.__defineGetter__("currentAnimation",function(){return this._currentAnimation}),this.__defineGetter__("fps",function(){return this.framesPerSecond}),this._frequencyInterval=setInterval(function(){i._update()},1e3/this.framesPerSecond)},_update:function(){var t=this._animations[this._currentAnimation];this.currentFrame==t.lastFrame?(this.currentFrame=t.firstFrame,this.trigger("animationStart")):(this.currentFrame=this.currentFrame+1,this.currentFrame==t.lastFrame&&this.trigger("animationEnd"))},addAnimation:function(t,i){var e=i[0],n=i[1];return this._animations[t]={firstFrame:e,lastFrame:n},this._animations.length=(this._animations.length||0)+1,this},onLoad:function(){this._super();var t=1;this._width<this.image.width&&(t=this._columns=Math.ceil(this.image.width/this._width)),this._height<this.image.height&&(t*=this._rows=Math.ceil(this.image.height/this._height)),(0===this._animations.length||null===this._currentAnimation)&&(this.addAnimation("default",[0,t-1]),this.play("default"))},play:function(t){if(this._currentAnimation!=t){if(this._currentAnimation=t,!this._animations[t])throw Error("Animation '"+t+"' not found on '"+this.id+"'");this.currentFrame=this._animations[t].firstFrame}return this},render:function(){this.visible&&(this.ctx.drawImage(this.image,this._width*(this.currentFrame%this._columns),this._height*(this.currentFrame/this._columns>>0),this._width,this._height,0,0,this._width,this._height),t.debug&&this.collider.renderStroke(this.ctx))}});t.SpriteSheet=i}(Joy),function(t){var i={TOP:"top",HANGING:"hanging",MIDDLE:"middle",ALPHABETIC:"alphabetic",IDEOGRAPHIC:"ideographic",BOTTOM:"bottom"},e="Normal 12px Verdana",n="#000000",s="left",o=i.TOP,h=t.DisplayObject.extend({init:function(t){t===void 0&&(t={}),this._super(t),this.text=t.text||"",this.font=t.font||e,this.align=t.align||s,this.baseline=t.baseline||o,this._color=t.color||n,this.__defineGetter__("color",function(){return this._color}),this.__defineSetter__("color",function(t){this._color=""+t}),t.stroke?this.useStroke():this.useFill()},useStroke:function(){this.stroke=!0,this.fillMethod="strokeText",this.styleMethod="strokeStyle"},useFill:function(){this.stroke=!1,this.fillMethod="fillText",this.styleMethod="fillStyle"},updateContext:function(){this._super(),this.ctx.font=this.font,this.ctx.textAlign=this.align,this.ctx.textBaseline=this.baseline,this.ctx[this.styleMethod]=this.color,this.ctx[this.fillMethod](this.text,0,0)},getMeasure:function(){this.ctx.measureText(this.text)}});h.BASELINE=i,t.Text=h}(Joy),function(t){var i=t.Object.extend({});Joy.Behaviour=i}(Joy),function(t){var i=t.DisplayObjectContainer.extend({init:function(i){i||(i={}),this._super(i),this.paused=!1,this.shaders=[],this.viewport=i.viewport||new t.Viewport({scene:this})},background:function(t){return this._backgroundColor=t,this.fillStyle(""+t),this.fillRect(0,0,this.width,this.height),this},pause:function(i){return i=i||{},i.blur&&(this.render(),t.Shader.process(this.ctx,t.Shader.blur,i.blur)),this.paused=!0,this.trigger("pause"),this},updateContext:function(){this._super(),this.viewport.follow&&this.viewport.updateContext()},render:function(){if(!this.paused&&(this.updateContext(),this._super(),this.viewport.render(),t.Mouse.collider.renderStroke(this.ctx),this.shaders.length>0))for(var i=0,e=this.shaders.length;e>i;++i)t.Shader.process(this.ctx,this.shaders[i][0],this.shaders[i][1])},addShader:function(t,i){return this.shaders.push([t,i]),this}});t.Scene=i}(Joy),function(t){var i=t.Triggerable.extend({init:function(i){this._super(i),this.id=i.id||Joy.generateUniqueId(),this.position=new t.Vector2d,this._lastPosition=new t.Vector2d,this.translation=new t.Vector2d,i.scene&&(this.scene=i.scene,this.ctx=this.scene.ctx),this.hud=new t.DisplayObjectContainer({id:this.id+"_HUD",ctx:this.ctx}),this.hud.position=this.position,this.active=!0,this.setup(i)},addHud:function(t){return this.hud.addChild(t)},setup:function(i){this.width=i.width,this.height=i.height,i.follow&&(this.follow=i.follow),this.scale=new t.Vector2d(1,1),this.width&&this.height&&this.setSize(this.width,this.height)},setSize:function(t,i){return this.width=t,this.height=i,this.ctx.scale(this.ctx.canvas.width/this.width*this.scale.x,this.ctx.canvas.height/this.height*this.scale.y),this.scale.x=this.width/this.ctx.canvas.width,this.scale.y=this.height/this.ctx.canvas.height,this},setDeadzone:function(i,e){return this.deadzone=new t.Vector2d(i,e),this},updateContext:function(){this.width/2,this.height/2,this.position.x=~~(this.follow.position.x+this.follow.width/2-this.width/2),this.position.y=~~(this.follow.position.y+this.follow.height/2-this.height/2),this.translation.x=-this.position.x+this._lastPosition.x,this.translation.y=-this.position.y+this._lastPosition.y,this.active&&(this.trigger("translate"),this.ctx.translate(this.translation.x,this.translation.y)),this._lastPosition.x=this.position.x,this._lastPosition.y=this.position.y},render:function(){this.hud.render()}});t.Viewport=i}(Joy),function(t){var i=t.Behaviour.extend({INIT:function(){this.velocity=new t.Vector2d,this.__defineGetter__("direction",function(){return this.velocity.normalized}),this.maxVelocity=new t.Vector2d(500,500),this.acceleration=new t.Vector2d,this.friction=new t.Vector2d},UPDATE:function(){this.friction.x&&(this.velocity.x=t.Utils.applyFriction(this.velocity.x,this.friction.x)),this.friction.y&&(this.velocity.y=t.Utils.applyFriction(this.velocity.y,this.friction.y)),this.velocity.x+=this.acceleration.x*t.deltaTime,this.velocity.y+=this.acceleration.y*t.deltaTime,0!==this.velocity.x&&(this.velocity.x=Math.clamp(this.velocity.x,-this.maxVelocity.x,this.maxVelocity.x)),0!==this.velocity.y&&(this.velocity.y=Math.clamp(this.velocity.y,-this.maxVelocity.y,this.maxVelocity.y)),this.position.x+=this.velocity.x,this.position.y+=this.velocity.y}});t.Behaviour.Movimentation=i}(Joy),function(t){var i=function(t,i,e){this.position=t,this.collidePosition=this.position.clone(),this.width=i,this.height=e};i.prototype.updateColliderPosition=function(t){this.collidePosition.x=t.x+this.position.x,this.collidePosition.y=t.y+this.position.y},i.prototype.renderStroke=function(t){t.strokeStyle="black",t.strokeRect(this.collidePosition.x,this.collidePosition.y,this.width,this.height)},i.prototype.collide=function(t){return!(this.collidePosition.x>=t.collidePosition.x+t.width||t.collidePosition.x>=this.collidePosition.x+this.width||this.collidePosition.y>=t.collidePosition.y+t.height||t.collidePosition.y>=this.collidePosition.y+this.height)},i.prototype.clone=function(){return new i(this.position.clone(),this.width,this.height)},t.RectCollider=i}(Joy),function(t){t.CompositeOperation={SOURCE_OVER:"source-over",SOURCE_IN:"source-in",SOURCE_OUT:"source-out",SOURCE_ATOP:"source-atop",LIGHTER:"lighter",XOR:"xor",DESTINATION_OVER:"destination-over",DESTINATION_IN:"destination-in",DESTINATION_OUT:"destination-out",DESTINATION_ATOP:"destination-atop",DESTINATION_COPY:"copy"}}(Joy),function(t){t.currentEngine=null;var i=function(i){if(t.currentEngine=this,this.scenes=[],this.paused=!1,i.canvas2d&&(this.context=new Joy.Context.Context2d({canvas:i.canvas2d})),i.canvas3d,!this.context){var e=i.context||Joy.Context.Context2d;this.context=new e({canvas:document.createElement("canvas")}),document.body.appendChild(this.context.canvas)}i.width&&(this.context.canvas.width=i.width),i.height&&(this.context.canvas.height=i.height),t.Mouse!==void 0&&t.Mouse.enable(this),i.markup&&this.useMarkup(),i.debug&&(Joy.debug=!0),this.__defineGetter__("width",function(){return this.context.canvas.width}),this.__defineGetter__("height",function(){return this.context.canvas.height}),this.__defineGetter__("currentScene",function(){return this.scenes[this._currentScene]}),this._currentScene=null,Joy.debug?(this._lastRenderTime=new Date,this._frameRateText=new Joy.Text({x:4,y:4,font:"12px Verdana",color:"red"}),this.onEnterFrameDebug()):this.onEnterFrame()};i.prototype.createScene=function(){var i=new t.Scene({ctx:this.context.ctx});return this.addScene(i),i},i.prototype.pause=function(){this._deltaTime=t.deltaTime,t.deltaTime=0,this.paused=!0},i.prototype.resume=function(){t.deltaTime=this._deltaTime,this.paused=!1},i.prototype.addScene=function(t){t.engine=this,t.setContext(this.context.ctx),Joy.debug&&(console.log("Add hud!"),t.viewport.addHud(this._frameRateText)),this._currentScene=this.scenes.push(t)-1},i.prototype.render=function(){this.context.render(this.scenes)},i.prototype.useMarkup=function(){var i=new t.Markup;i.analyse(this.context)},i.prototype.onEnterFrame=function(){t.currentEngine.paused||t.currentEngine.render(),window.onEnterFrame(t.currentEngine.onEnterFrame)},i.prototype.onEnterFrameDebug=function(){var i=new Date;t.currentEngine._frameRateText.text=""+(1e3/(i-t.currentEngine._lastRenderTime)).toFixed(1)+" FPS",t.currentEngine.paused||t.currentEngine.render(),t.currentEngine._lastRenderTime=i,window.onEnterFrame(t.currentEngine.onEnterFrameDebug)},t.Engine=i}(Joy),function(t){var i=function(t,i){this.position=t,this.radius=i};i.prototype.render=function(){},t.Circle=i}(Joy),function(t){var i=function(t){if(this.points=[],t)for(var i=0,e=t.length;e>i;++i)this.addPoint(t[i])};i.prototype.addPoint=function(t){this.points.push(t)},i.prototype.render=function(){},t.Polygon=i}(Joy),function(t){var i=t.DisplayObject.extend({init:function(t){this._super(t),t.color&&this.colorize(t.color)},colorize:function(t){return this.color=""+t,this},updateContext:function(){this._super()},render:function(){this.color&&(this.ctx.fillStyle=this.color),this.ctx.fillRect(0,0,this._width,this._height)}});t.Rect=i}(Joy),function(t){var i=function(t,e){this.x=t||0,this.y=e||0,this.__defineGetter__("length",function(){return Math.sqrt(this.x*this.x+this.y*this.y)}),this.__defineGetter__("normalized",function(){var t=this.length;return new i(this.x/t,this.y/t)})};i.prototype.set=function(t,i){return this.x=t,this.y=i,this},i.prototype.subtract=function(t){return this.x-=t.x,this.y-=t.y,this},i.prototype.sum=function(t){return this.x+=t.x,this.y+=t.y,this},i.prototype.scale=function(t,i){return this.x*=t,this.y*=i,this},i.prototype.clone=function(){return new i(this.x,this.y)},i.prototype.unit=function(){return new i(Math.cos(this.x),Math.sin(this.y))},i.prototype.normalize=function(){var t=this.normalized;return this.x=t.x,this.y=t.y,this},i.distance=function(t){var i=this.x-t.x,e=this.y-t.y;return Math.sqrt(i*i+e*e)},i.prototype.toString=function(){return"#<Vector2d @x="+this.x+", @y="+this.y+">"},i.LEFT=new i(-1,0),i.RIGHT=new i(1,0),i.TOP=new i(0,-1),i.BOTTOM=new i(0,1),t.Vector2d=i}(Joy),function(J){var $="undefined"!=typeof Sizzle?Sizzle:null,Markup=function(){};Markup.prototype.analyse=function(t){var i,e,n,s=$("img",t.canvas);for(e=s.length,i=0;e>i;++i)n=this.evaluateDataset.call(s[i],s[i].dataset,t.context),t.addChild(new Joy.Sprite({x:s[i].dataset.x,y:s[i].dataset.y,asset:s[i]}));var o=$("label",t.canvas);for(e=o.length,i=0;e>i;++i)n=this.evaluateDataset(o[i].dataset,t.context),n.text=o[i].innerHTML,t.addChild(new Joy.Text(n))},Markup.prototype.evaluateDataset=function(dataset,context){var attr,matches,width=context.canvas.width,height=context.canvas.height;for(var key in dataset)attr=dataset[key],matches=attr.match(/\{\{([^\}]*)\}\}/),matches&&(dataset[key]=attr.replace(attr,eval(matches[1])));return dataset},J.Markup=Markup}(Joy),function(t){var i=function(){};t.Package=i}(Joy),function(t){var i=function(t,i,e,n){this.red=t,this.green=i,this.blue=e,this.alpha=n};i.prototype.toString=function(){return this.green||this.blue?this.alpha?"rgba("+this.red+","+this.green+","+this.blue+","+this.alpha+")":"rgb("+this.red+","+this.green+","+this.blue+")":this.red},t.Color=i}(Joy),function(){Math.clamp=function(t,i,e){return i>t?i:t>e?e:+t}}(Joy),function(t){t.Utils={applyFriction:function(i,e){return 0>i+e?i+e*t.deltaTime:i-e>0?i-e*t.deltaTime:0}}}(Joy),function(t){t.DisplayObject.extend({init:function(){}})}(Joy),function(t){function i(t,i){var n,s,o=e.handlers[t];for(n=0,s=o.length;s>n;++n)o[n].handler.apply(o[n].target,[i])}var e={ENTER:13,SPACE:32,BACKSPACE:8,TAB:9,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPSLOCK:20,ESCAPE:27,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,SELECT:93,NUMPAD0:96,NUMPAD1:97,NUMPAD2:98,NUMPAD3:99,NUMPAD4:100,NUMPAD5:101,NUMPAD6:102,NUMPAD7:103,NUMPAD8:104,NUMPAD9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMALPOINT:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUMLOCK:144,SCROLLLOCK:145,SEMICOLON:186,EQUALSIGN:187,COMMA:188,DASH:189,PERIOD:190,FORWARDSLASH:191,GRAVEACCENT:192,OPENBRACKET:219,BACKSLASH:220,CLOSEBRAKET:221,SINGLEQUOTE:222};t.Events.KEY_DOWN="onkeydown",t.Events.KEY_UP="onkeyup",t.Events.KEY_PRESS="key",e.handlers={},e.timers={},[t.Events.KEY_DOWN,t.Events.KEY_UP,t.Events.KEY_PRESS].forEach(function(i){e.handlers[i]=[],t.Triggerable.register(i,function(t){-1===e.handlers[i].indexOf(t)&&e.handlers[i].push(t)},function(t){var n=e.handlers[i].indexOf(t);-1!==n&&e.handlers[i].splice(n,1)})});var n=1;document.onkeydown=function(s){var o=(s||window.event).keyCode;return e.timers[o]||(i(t.Events.KEY_DOWN,s),i(t.Events.KEY_PRESS,s),0!==n&&(e.timers[o]=setInterval(function(){i(t.Events.KEY_PRESS,s)},n))),!1},document.onkeyup=function(n){var s=(n||window.event).keyCode;s in e.timers&&(i(t.Events.KEY_UP,n),e.timers[s]&&clearInterval(e.timers[s]),delete e.timers[s])},Joy.Keyboard=e}(Joy),function(t){t.Events.MOUSE_DOWN="mousedown",t.Events.MOUSE_UP="mouseup",t.Events.CLICK="click",t.Events.DOUBLE_CLICK="dblclick",t.Events.MOUSE_MOVE="mousemove",t.Events.MOUSE_OVER="mouseover",t.Events.MOUSE_OUT="mouseout";var i={collider:new t.RectCollider(new t.Vector2d,1,1),enable:function(t){var e=function(e){i.collider.position.x=e.offsetX*t.currentScene.viewport.scale.x,i.collider.position.y=e.offsetY*t.currentScene.viewport.scale.y,i.collider.updateColliderPosition(t.currentScene.viewport.position)},n=function(t){var n=i.handlers[t.type];e(t);for(var s=0,o=n.length;o>s;++s)n[s].target.visible&&n[s].target.collider.collide(i.collider)&&n[s].handler.apply(n[s].target,[t])};t.context.canvas.onclick=n,t.context.canvas.onmousedown=n,t.context.canvas.onmouseup=n,t.context.canvas.onmousemove=n},handlers:{}};[t.Events.CLICK,t.Events.DOUBLE_CLICK,t.Events.MOUSE_MOVE,t.Events.MOUSE_DOWN,t.Events.MOUSE_UP].forEach(function(e){i.handlers[e]=[],t.Triggerable.register(e,function(t){-1===i.handlers[e].indexOf(t)&&i.handlers[e].push(t)},function(t){var n=i.handlers[e].indexOf(t);-1!==n&&i.handlers[e].splice(n,1)})}),t.Mouse=i}(Joy),function(t){var i=t.DisplayObjectContainer.extend({init:function(i){this._super(i),this.viewport=i.viewport||null,this.distance=i.distance||1,this.velocity=i.velocity||1,this.bind(t.Events.ADDED,this._setup)},_setup:function(i){if(!(i instanceof t.Scene))throw Error("'Parallax' instance must be added into a 'Scene'.");this.viewport=i.viewport;var e=this;this.viewport.bind("translate",function(){for(var t=e.distance,i=0,n=e.numChildren;n>i;++i)t*=e.velocity*(i+1),e.getChildAt(i).position&&(e.getChildAt(i).position.x+=this.translation.x*t/this.width,e.getChildAt(i).position.y+=this.translation.y*t/(this.height/2))})}});t.Parallax=i}(Joy),function(t){var i=t.DisplayObject.extend({init:function(t){this._super(t)}});t.ParticleEmitter=i}(Joy),function(t){var i=function(){};i.process=function(t,i){var e=t.getImageData(0,0,t.canvas.width,t.canvas.height);i.call(this,e),t.putImageData(e,0,0)};var e=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],n=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];i.blur=function(t){var i,s,o,h,r,a,c,l,d,u,f,p,_,m,x,g,y,v,E,w,b,C=function(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null},O=t.data,S=5,T=t.width,P=t.height,A=S+S+1,D=T-1,M=P-1,I=S+1,k=I*(I+1)/2,R=new C,Y=R;for(o=1;A>o;o++)Y=Y.next=new C,o==I&&(b=Y);Y.next=R;var K=null,J=null;c=a=0;var N=e[S],F=n[S];for(s=0;P>s;s++){for(m=x=g=l=d=u=0,f=I*(y=O[a]),p=I*(v=O[a+1]),_=I*(E=O[a+2]),l+=k*y,d+=k*v,u+=k*E,Y=R,o=0;I>o;o++)Y.r=y,Y.g=v,Y.b=E,Y=Y.next;for(o=1;I>o;o++)h=a+((o>D?D:o)<<2),l+=(Y.r=y=O[h])*(w=I-o),d+=(Y.g=v=O[h+1])*w,u+=(Y.b=E=O[h+2])*w,m+=y,x+=v,g+=E,Y=Y.next;for(K=R,J=b,i=0;T>i;i++)O[a]=l*N>>F,O[a+1]=d*N>>F,O[a+2]=u*N>>F,l-=f,d-=p,u-=_,f-=K.r,p-=K.g,_-=K.b,h=c+(D>(h=i+S+1)?h:D)<<2,m+=K.r=O[h],x+=K.g=O[h+1],g+=K.b=O[h+2],l+=m,d+=x,u+=g,K=K.next,f+=y=J.r,p+=v=J.g,_+=E=J.b,m-=y,x-=v,g-=E,J=J.next,a+=4;c+=T}for(i=0;T>i;i++){for(x=g=m=d=u=l=0,a=i<<2,f=I*(y=O[a]),p=I*(v=O[a+1]),_=I*(E=O[a+2]),l+=k*y,d+=k*v,u+=k*E,Y=R,o=0;I>o;o++)Y.r=y,Y.g=v,Y.b=E,Y=Y.next;for(r=T,o=1;S>=o;o++)a=r+i<<2,l+=(Y.r=y=O[a])*(w=I-o),d+=(Y.g=v=O[a+1])*w,u+=(Y.b=E=O[a+2])*w,m+=y,x+=v,g+=E,Y=Y.next,M>o&&(r+=T);for(a=i,K=R,J=b,s=0;P>s;s++)h=a<<2,O[h]=l*N>>F,O[h+1]=d*N>>F,O[h+2]=u*N>>F,l-=f,d-=p,u-=_,f-=K.r,p-=K.g,_-=K.b,h=i+(M>(h=s+I)?h:M)*T<<2,l+=m+=K.r=O[h],d+=x+=K.g=O[h+1],u+=g+=K.b=O[h+2],K=K.next,f+=y=J.r,p+=v=J.g,_+=E=J.b,m-=y,x-=v,g-=E,J=J.next,a+=T}},i.noise=function(t){var i,e,n,s=0;for(i=0;t.width>i;++i)for(e=0;t.height>e;++e)n=.8*Math.random(),s=4*i+e*4*t.width,t.data[s]*=n,t.data[s+1]*=n,t.data[s+2]*=n},t.Shader=i}(Joy),function(t){var i=t.DisplayObjectContainer.extend({init:function(i){if(!(i.tileset instanceof t.Tileset))throw Error("'tileset' must be given on Tilemap constructor, as Sprite instance.");this._super(i),this.tileset=i.tileset,this.lines=i.lines||1,this.columns=i.columns||1,this.__defineSetter__("data",function(i){this._data=i,(this.collider==this||this.collider instanceof t.TilemapCollider)&&(this.collider=new t.TilemapCollider(this))}),this.__defineGetter__("data",function(){return this._data}),this.data=i.data,this.__defineGetter__("height",function(){return this.lines*this.tileset.tileHeight}),this.__defineGetter__("width",function(){return this.columns*this.tileset.tileWidth})},renderChildren:function(){for(var t=0,i=this.data.length;i>t;++t)0!==this.data[t]&&this.ctx.drawImage(this.tileset.image,this.tileset.tileWidth*((this.data[t]-1)%this.tileset.columns),this.tileset.tileHeight*((this.data[t]-1)/this.tileset.columns>>0),this.tileset.tileWidth,this.tileset.tileHeight,this.tileset.tileWidth*(t%this.columns),this.tileset.tileHeight*(t/this.columns>>0),this.tileset.tileWidth,this.tileset.tileHeight)}});t.Tilemap=i}(Joy),function(t){var i=function(i){this.blocks=[];for(var e=0,n=i.data.length;n>e;++e)0!==i.data[e]&&this.blocks.push(new Joy.RectCollider(new t.Vector2d(i.tileset.tileWidth*(e%i.columns),i.tileset.tileHeight*(e/i.columns>>0)),i.tileset.tileWidth,i.tileset.tileHeight));this.length=this.blocks.length};i.prototype.collide=function(t){for(var i=0;this.length>i;++i)if(!(this.blocks[i].collidePosition.x>=t.collidePosition.x+t.width||t.collidePosition.x>=this.blocks[i].collidePosition.x+this.blocks[i].width||this.blocks[i].collidePosition.y>=t.collidePosition.y+t.height||t.collidePosition.y>=this.blocks[i].collidePosition.y+this.blocks[i].height))return!0;
return!1},i.prototype.renderStroke=function(t){for(var i=0;this.length>i;++i)t.strokeRect(this.blocks[i].position.x,this.blocks[i].position.y,this.blocks[i].width,this.blocks[i].height)},t.TilemapCollider=i}(Joy),function(t){var i=t.Sprite.extend({init:function(t){this.tileWidth=t.width,this.tileHeight=t.height,delete t.width,delete t.height,this._super(t)},onLoad:function(){this._super(),this.columns=this._width/this.tileWidth>>0,this.lines=this._height/this.tileHeight>>0}});t.Tileset=i}(Joy),function(t){function i(t){return""!==n&&(t=t.charAt(0).toUpperCase()+t.slice(1)),n+t}var e=navigator.userAgent,n=e.match(/opera/i)&&"o"||e.match(/webkit/i)&&"webkit"||e.match(/msie/i)&&"ms"||e.match(/mozilla/i)&&"moz"||"";t.Support={imageSmoothingEnabled:i("imageSmoothingEnabled")},window.onEnterFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}()}(Joy);